databaseChangeLog:
  - changeSet:
      id: 1
      author: jason
      changes:
        - createTable:
            tableName: account
            columns:
              - column:
                  name: id
                  type: char(4)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(45)
              - column:
                  name: image_prefix
                  type: varchar(45)
              - column:
                  name: colour
                  type: char(6)

        - createTable:
            tableName: category
            columns:
              - column:
                  name: id
                  type: char(3)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(45)
              - column:
                  name: sort
                  type: int(11)
              - column:
                  name: restricted
                  type: boolean
                  constraints:
                    nullable: false;
              - column:
                  name: expense
                  type: boolean
                  constraints:
                    nullable: false;
              - column:
                  name: colour
                  type: char(6)
              - column:
                  name: groupid
                  type: varchar(45)
              - column:
                  name: system_use
                  type: boolean
                  constraints:
                    nullable: false;

        - createTable:
            tableName: reconciliation_data
            columns:
              - column:
                  name: id
                  type: int(11)
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: category
                  type: char(3)
              - column:
                  name: date
                  type: datetime
              - column:
                  name: amount
                  type: decimal(10,2)
              - column:
                  name: description
                  type: varchar(40)
              - column:
                  name: colour
                  type: char(6)

        - addForeignKeyConstraint:
            constraintName: fk_category_rec
            baseTableName: reconciliation_data
            baseColumnNames: category
            referencedTableName: category
            referencedColumnNames: id

        - createTable:
            tableName: statement
            columns:
              - column:
                  name: account
                  type: char(4)
                  constraints:
                    nullable: false
              - column:
                  name: month
                  type: int(11)
                  constraints:
                    nullable: false
              - column:
                  name: year
                  type: int(11)
                  constraints:
                    nullable: false
              - column:
                  name: open_balance
                  type: decimal(10,2)
              - column:
                  name: locked
                  type: boolean

        - addPrimaryKey:
            tableName: statement
            columnNames: account, month, year

        - addForeignKeyConstraint:
            constraintName: fk_account_statement
            baseTableName: statement
            baseColumnNames: account
            referencedTableName: account
            referencedColumnNames: id

        - createTable:
            tableName: transaction
            columns:
              - column:
                  name: id
                  type: int(11)
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: account
                  type: char(4)
              - column:
                  name: category
                  type: char(3)
              - column:
                  name: date
                  type: datetime
              - column:
                  name: amount
                  type: decimal(10,2)
              - column:
                  name: statement
                  type: char(7)
              - column:
                  name: oppositeid
                  type: int(11)
              - column:
                  name: description
                  type: varchar(40)

        - addForeignKeyConstraint:
            constraintName: fk_category_trn
            baseTableName: transaction
            baseColumnNames: category
            referencedTableName: category
            referencedColumnNames: id

        - addForeignKeyConstraint:
            constraintName: fk_account_trn
            baseTableName: transaction
            baseColumnNames: account
            referencedTableName: account
            referencedColumnNames: id

        - createTable:
            tableName: regular
            columns:
              - column:
                  name: id
                  type: int(11)
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: account
                  type: char(4)
              - column:
                  name: amount
                  type: decimal(10,2)
              - column:
                  name: category
                  type: char(3)
              - column:
                  name: frequency
                  type: char(2)
              - column:
                  name: weekend_adj
                  type: char(2)
              - column:
                  name: start
                  type: datetime
              - column:
                  name: last_created
                  type: datetime
              - column:
                  name: description
                  type: varchar(40)

        - addForeignKeyConstraint:
            constraintName: fk_category_reg
            baseTableName: regular
            baseColumnNames: category
            referencedTableName: category
            referencedColumnNames: id

        - addForeignKeyConstraint:
            constraintName: fk_account_reg
            baseTableName: regular
            baseColumnNames: account
            referencedTableName: account
            referencedColumnNames: id

        - createView:
            viewName: all_transaction
            selectQuery: select `t`.`id` AS `id`,
              `t`.`date` AS `date`,
              `t`.`amount` AS `amount`,
              `t`.`oppositeid` AS `opposite_id`,
              `t`.`statement` AS `statement_id`,
              `s`.`locked` AS `locked`,
              `t`.`account` AS `account_id`,
              `t`.`category` AS `category_id`,
              `c`.`name` AS `category_name`,
              `c`.`colour` AS `colour`,
              `c`.`groupid` AS `category_group`,
              `o`.`statement` AS `opp_statement_id`,
              `t`.`description` AS `description`
              from (((`transaction` `t`
              left join `statement` `s` on(((`t`.`account` = `s`.`account`) and (`t`.`statement` = ((`s`.`year` * 100) + `s`.`month`)))))
              left join `category` `c` on((`t`.`category` = `c`.`id`)))
              left join `transaction` `o` on((`t`.`id` = `o`.`oppositeid`)));

  - include:
      file: /db/changelog/db.changelog-002-accounts.yaml

  - include:
      file: /db/changelog/db.changelog-003-categories.yaml
